# v1.0 Launch Execution

This runbook operationalizes release readiness with four hard gates.

## Release Decision Model

### Go criteria (all required)

1. Production smoke passes on all active frontend origins.
2. Telemetry validation passes with metadata-only logging and expected sampling/rate-limit behavior.
3. `release-tag.yml` dry run succeeds and creates exactly one expected tag/release.
4. Rollback rehearsal succeeds and restores prior known-good state.
5. No Sev-1/Sev-2 regressions during 24h observation window after first prod tag.

### No-go criteria (any one blocks release)

1. CSRF/origin failures on production domains (`E2002`, `E2003`, `E2004`).
2. Stream contract failure (missing delta/done behavior or cancel regression).
3. Telemetry emits content-like fields or exceeds expected sampling controls.
4. Release workflow duplicates tags/releases or triggers recursively.
5. Rollback cannot be completed quickly and deterministically.

## Gate A: Health + Preflight CORS Matrix (No Creds Required)

### Required scope

- `ORIGIN=https://omniplexity.github.io`
- Any custom frontend domain in use
- `BASE_URL` (or `API_BASE_URL`) set to `https://omniplexity.duckdns.org`
- Include at least one negative control origin (for example `https://evil.example.com`)

### Commands

- Bash:
  - `API_BASE_URL=https://omniplexity.duckdns.org ORIGINS=https://omniplexity.github.io,https://evil.example.com ALLOWED_ORIGINS=https://omniplexity.github.io GATE_A_MODE=preflight bash scripts/launch-gate-a.sh`
- PowerShell:
  - `$env:API_BASE_URL="https://omniplexity.duckdns.org"; $env:ORIGINS="https://omniplexity.github.io,https://evil.example.com"; $env:ALLOWED_ORIGINS="https://omniplexity.github.io"; $env:GATE_A_MODE="preflight"; .\scripts\launch-gate-a.ps1`

### Pass criteria

1. `/health` is reachable.
2. Allowed origins return credentialed preflight headers:
   - `Access-Control-Allow-Origin` exact origin
   - `Access-Control-Allow-Credentials: true`
   - `Vary` contains `Origin`
3. Disallowed origins do not receive `Access-Control-Allow-Origin` or `Access-Control-Allow-Credentials`.

## Gate B: Authenticated Smoke (Creds Required)

### Commands

- Bash:
  - `API_BASE_URL=https://omniplexity.duckdns.org ORIGINS=https://omniplexity.github.io ALLOWED_ORIGINS=https://omniplexity.github.io GATE_A_MODE=smoke SMOKE_USERNAME=<smoke-user> SMOKE_PASSWORD=<smoke-pass> bash scripts/launch-gate-a.sh`
- PowerShell:
  - `$env:API_BASE_URL="https://omniplexity.duckdns.org"; $env:ORIGINS="https://omniplexity.github.io"; $env:ALLOWED_ORIGINS="https://omniplexity.github.io"; $env:GATE_A_MODE="smoke"; $env:SMOKE_USERNAME="<smoke-user>"; $env:SMOKE_PASSWORD="<smoke-pass>"; .\scripts\launch-gate-a.ps1`

### Secret handling rules

1. `SMOKE_USERNAME` and `SMOKE_PASSWORD` are out-of-repo operational secrets only.
2. Gate B smoke runs only for allowed origins.
3. Disallowed origins remain preflight-only checks.

### Pass criteria

1. Gate A preflight checks pass for allowed origin.
2. CSRF bootstrap returns token and sets `omni_csrf`.
3. Authenticated conversation create succeeds.
4. Run create succeeds.
5. Stream returns delta/data and terminal done marker.
6. Cancel endpoint succeeds on long run.

## Gate C: Telemetry Validation (Flagged Rollout)

### Precondition

- Backend:
  - `CLIENT_EVENTS_ENABLED=true`
  - `CLIENT_EVENTS_MAX_SAMPLE_RATE=0.1`
  - Optional initial safety: `CLIENT_EVENTS_FORCE_SAMPLE_RATE=0.02`
- Frontend:
  - `FEATURE_FLAGS.CLIENT_EVENTS_HTTP=true`
  - Optional `FEATURE_FLAGS.CLIENT_EVENTS_SAMPLE_RATE` (backend must enforce max/force regardless)

### Validation checks

1. Request header present: `X-Client-Events-Sample-Rate`.
2. Endpoint response includes:
   - `accepted_count`
   - `dropped_count`
   - `effective_sample_rate`
   - `sampling_mode`
3. `effective_sample_rate` respects backend max/force.
4. `429` still occurs under forced load (independent of sampling).
5. Logs contain metadata only (no content payloads).

## Gate D: Release Automation Dry Run

### Scope

Manually dispatch `release-tag.yml` once.

### Checks

1. Workflow permissions allow tag + release creation.
2. Tag naming is monotonic and unique.
3. Existing-tag path is idempotent (no duplicate release).
4. Auto-run path constrained to:
   - `workflow_run.conclusion == success`
   - `head_branch == main`
   - `workflow_run.event == push`

## Gate E: Rollback Rehearsal

### Scope

Execute `docs/rollback-playbook.md` against staging-like deployment.

### Steps

1. Disable telemetry flags (frontend + backend).
2. Redeploy previous known-good frontend artifact/config.
3. Run smoke script and confirm chat core loop.
4. Verify `BUILD_INFO` reflects rolled-back version.

### Pass criteria

Rollback + verification completes within target SLO (recommended: under 30 minutes).

## Launch Sequence

1. Complete Gates A-E in order.
2. Freeze config changes except release owner.
3. Cut first production tag via release workflow.
4. Observe for 24 hours:
   - stream errors
   - auth/csrf failures
   - telemetry volume and 429 patterns
5. If stable, proceed to normal `v1.0.x` patch cadence.

## Evidence Requirements

Archive:

1. Smoke logs per origin/domain.
2. Gate A bundle archive (`gate-a-bundle-<ts>.zip`) with matrix + logs + env summary.
3. Telemetry validation response snippets and logs.
4. Release workflow run URL.
5. Rollback rehearsal notes and elapsed time.
6. Final go/no-go signoff record (`docs/v1.0-go-no-go.md`).
